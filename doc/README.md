# BeanCKUP CLI - 高性能增量备份工具

BeanCKUP CLI 是一款为开发者和高级用户设计的**跨平台命令行备份工具**。它通过先进的增量备份算法和并发处理技术，实现了极致的扫描速度和备份效率。

---

## 🌟 核心特性

### 🔍 高速并发扫描（全新优化）
- 采用 **生产者-消费者模型**
- 充分利用多核 CPU 和高速 SSD 的性能
- 并行化 I/O 和哈希计算，大幅提升扫描速度
- 即使面对数百万文件也能从容应对

### 💾 智能增量备份
- 通过“五元预筛”（路径、大小、时间戳等）快速判断文件是否变化
- 对可疑文件使用 SHA256 哈希校验，精确识别变动
- 只有真正新增或修改的文件会被物理打包，节省存储空间和备份时间

### 🧭 精确文件溯源
- 每个文件在清单（Manifest）中都有一个 `reference` 字段，格式为：  
  `包名.7z/文件在包内的路径`
- 这是实现可靠恢复的基石，确保任何文件都能被准确无误地找到

### 📦 原子化交付计划
- 所有交付操作都支持断点续传
- 即使程序中途退出，下次运行时也会自动检测未完成任务，并提示继续或重新开始
- 确保交付状态的完整性

### 🔁 可靠的文件恢复
- 恢复流程严格按照清单的 `reference` 字段执行，逻辑清晰无歧义
- 在目标目录下创建临时文件夹，解决跨盘恢复失败问题
- 能完整重现指定备份时间点的工作区全貌（包括 `.beanckup` 历史记录）

### 📊 实时进度反馈
- 扫描与打包过程中提供实时、平滑刷新的单行进度条
- 直观了解当前状态，告别“干等”
%#Rqo5d4YC8JfpcV
### ⚙️ 灵活的交付选项
- 支持按大小自动分卷打包
- 可限制单次交付总体积
- 支持设置不同压缩级别
- 支持添加密码进行加密，满足多样化的归档和传输需求

---

## 🚀 快速开始

请参考 [TECH_DOC.md](TECH_DOC.md) 中的 **快速上手指南** 部分，获取安装、编译和基本使用步骤。

---

## 🧠 软件如何工作？

BeanCKUP 的核心是其 **清单（Manifest）系统**。

### 1. 扫描与识别
- 执行扫描时，程序会高速并行检查文件
- 优先通过元数据（大小、修改时间等）判断文件是否未变
- 对于元数据有变化或路径找不到的文件，才会计算其“指纹”（SHA256 哈希），并与历史记录比对
- 精确识别出哪些是真正的新增文件，哪些只是被移动或重命名

### 2. 打包与记录
- 只有“新增文件”才会被物理压缩进新的交付包（`.7z` 文件）
- 每个交付包都会附带一份自己的清单（Manifest）
- 清单记录了当前工作区的完整文件列表
- 每个文件的 `reference` 字段标明其物理位置（哪个交付包、包内路径）

### 3. 恢复
- 恢复时加载对应版本的所有清单，生成完整的文件“地图”
- 严格按地图从不同交付包中提取所需文件
- 完美还原当时的文件结构
- 所有历史清单也被一并恢复，使得恢复出的文件夹可直接用于下一次备份

---

## 📁 目录结构

本仓库采用模块化设计，主要目录和文件说明如下：

```
BeAnCKUP/                  # 主程序源码目录（Go 语言实现）
│
├── main.go                # 程序入口，主菜单与主流程编排
├── go.mod / go.sum        # Go 依赖管理文件
├── beanckup-cli.exe       # 已编译的命令行可执行文件（如有）
├── internal/              # 主要核心模块
│   ├── indexer/           # 高性能并发扫描模块
│   │   └── indexer.go     # ScanWithProgress等扫描逻辑
│   ├── packager/          # 打包与进度反馈模块
│   │   └── packager.go    # 7z打包、进度解析等
│   ├── restorer/          # 可靠恢复模块
│   │   └── restorer.go    # 按清单恢复文件的核心逻辑
│   └── types.go           # 所有核心数据结构定义（FileNode, Plan, Manifest等）
│
├── session/               # 交付计划与会话管理
│   └── session.go         # Plan/Episode的创建与管理
├── util/                  # 工具函数（进度条、显示、通用辅助）
│   └── util.go
├── history/               # 历史状态加载与管理
│   └── history.go
│
├── doc/                   # 项目文档
│   ├── README.md          # 项目简介与快速上手（本文件）
│   ├── Tech_doc.md        # 技术架构与核心原理详细说明
│   └── ...                # 其它文档
│
├── .gitignore             # Git忽略配置
└── ...                    # 其它辅助文件
```

### 主要目录与文件说明

- **main.go**  
  程序主入口，负责菜单交互、主流程调度（如扫描、交付、恢复等）。

- **internal/types.go**  
  定义核心数据结构，包括 FileNode（文件节点）、Plan（交付计划）、Manifest（清单）等，是所有模块协作的基础。

- **internal/indexer/indexer.go**  
  实现并发扫描逻辑，利用生产者-消费者模型和多核并行，极大提升大规模文件扫描效率。

- **internal/packager/packager.go**  
  封装7z打包调用，负责分卷、进度反馈、压缩参数等，确保打包过程高效且可追踪。

- **internal/restorer/restorer.go**  
  实现可靠恢复流程，严格按清单 reference 字段从各交付包中提取文件，支持断点续恢复。

- **session/session.go**  
  管理交付计划（Plan）与分卷（Episode），支持断点续传和任务恢复。

- **history/history.go**  
  管理和加载历史清单状态，支持五元预筛和哈希比对，提升增量识别效率。

- **util/util.go**  
  提供进度条、用户交互、通用辅助函数等。

- **doc/**  
  存放项目说明文档，包括快速上手、技术细节、使用案例等。

### 运行与使用流程

1. **编译/运行**  
   - 直接运行 `go build -o beanckup-cli main.go` 编译主程序。
   - 运行 `./beanckup-cli` 启动交互式命令行。

2. **备份流程**  
   - 选择“扫描和交付”，输入工作区路径，程序自动并发扫描并生成交付计划。
   - 按提示设置分卷大小、压缩级别、加密等参数，确认后自动打包并生成清单。

3. **恢复流程**  
   - 选择“恢复文件”，输入交付包目录和目标恢复路径，按提示选择历史会话，自动还原所有文件和历史记录。

4. **断点续传**  
   - 任何交付/恢复中断后，重新运行程序会自动检测未完成任务并提示继续。

### 其它说明

- **.beanckup/**  
  每个工作区下自动生成的隐藏目录，存放所有历史清单和状态文件，是增量备份和恢复的核心数据。

- **依赖**  
  - 需安装 Go 1.18+ 环境
  - 需系统已安装 7-Zip 命令行工具（7z.exe 并加入 PATH）

- **详细技术原理**  
  请参考 [doc/Tech_doc.md](doc/Tech_doc.md) 获取完整的架构设计、数据结构和模块协作说明。

---

如需进一步了解每个模块的职责和调用关系，建议结合 `doc/Tech_doc.md` 的流程图和注释阅读。
